// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- MODELOS NUEVOS ---

// El "Amigo" o Entidad recurrente
model Participant {
  id        String   @id @default(uuid())
  name      String
  imageUrl  String?  // URL de su foto oficial
  createdAt DateTime @default(now())
  
  // Relación inversa: En qué encuestas ha sido nominado
  nominations Option[]
}

model Poll {
  id            String     @id @default(uuid())
  title         String
  description   String?
  votingType    VotingType @default(SINGLE)
  maxChoices    Int?
  
  order         Int        @default(0) // <--- NUEVO CAMPO
  
  startAt       DateTime   @default(now())
  endAt         DateTime
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  isPublished   Boolean    @default(false)
  
  options       Option[]
  votes         Vote[]
}

// La "Nominación": Un participante en una encuesta específica
model Option {
  id            String      @id @default(uuid())
  pollId        String
  participantId String
  
  // Campos opcionales específicos de esta nominación
  // Ej: Participant es "Juan", pero subtitle es "Por dormirse en el cine"
  subtitle      String?     
  
  order         Int         @default(0)
  createdAt     DateTime    @default(now())

  poll          Poll        @relation(fields: [pollId], references: [id], onDelete: Cascade)
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  
  votes         VoteOption[]

  // Un amigo solo puede estar una vez en la misma encuesta
  @@unique([pollId, participantId])
}

// --- SISTEMA DE VOTOS (Mantenemos igual la lógica) ---

model Vote {
  id          String       @id @default(uuid())
  pollId      String
  createdAt   DateTime     @default(now())
  
  // CAMBIO: Hacemos obligatorio el hash del votante
  voterHash   String       

  poll        Poll         @relation(fields: [pollId], references: [id], onDelete: Cascade)
  voteOptions VoteOption[]

  // REGLA DE ORO: Un votante (voterHash) solo puede tener un voto por encuesta (pollId)
  @@unique([pollId, voterHash])
  @@index([pollId])
}

model VoteOption {
  id       String @id @default(uuid())
  voteId   String
  optionId String
  
  vote     Vote   @relation(fields: [voteId], references: [id], onDelete: Cascade)
  option   Option @relation(fields: [optionId], references: [id], onDelete: Cascade)
}

enum VotingType {
  SINGLE
  MULTIPLE
  LIMITED_MULTIPLE
}